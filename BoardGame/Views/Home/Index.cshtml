@using WebMatrix.Data;

@{
    var db = Database.Open("BoardGame");

    var sGName = Request.Form["searchGameName"];
    var gCategory = Request.Form["searchCategory"];

    var sql = "";
    var data = new List<dynamic>();

    // category id and names from Category table
    var categories = db.Query(@"SELECT DISTINCT c.CategoryID, c.Category FROM Category c ORDER BY c.Category ASC").ToList();

    // Default display all game details
    if (String.IsNullOrEmpty(sGName) && String.IsNullOrEmpty(gCategory))
    {
        sql = @"SELECT b.BGGId, b.Name, b.Description, b.YearPublished, b.GameWeight, b.ImagePath, c.Category
                FROM BoardGame b
                LEFT JOIN GameCategory gc ON b.BGGId = gc.BGGId
                LEFT JOIN Category c ON gc.Category = c.CategoryID
                ORDER BY b.Name ASC";
        data = db.Query(sql).ToList();
    }
    // Search by Game Name 
    else if (!String.IsNullOrEmpty(sGName) && String.IsNullOrEmpty(gCategory))
    {
        sql = @"SELECT b.BGGId, b.Name, b.Description, b.YearPublished, b.GameWeight, b.ImagePath, c.Category
                FROM BoardGame b
                LEFT JOIN GameCategory gc ON b.BGGId = gc.BGGId
                LEFT JOIN Category c ON gc.Category = c.CategoryID
                WHERE b.Name LIKE CONCAT(@0, '%')
                ORDER BY b.Name ASC";
        data = db.Query(sql, sGName).ToList();
    }
    // Search by Category 
    else if (String.IsNullOrEmpty(sGName) && !String.IsNullOrEmpty(gCategory))
    {
        sql = @"SELECT b.BGGId, b.Name, b.Description, b.YearPublished, b.GameWeight, b.ImagePath, c.Category
                FROM BoardGame b
                INNER JOIN GameCategory gc ON b.BGGId = gc.BGGId
                INNER JOIN Category c ON gc.Category = c.CategoryID
                WHERE c.CategoryID = @0
                ORDER BY b.Name ASC";
        data = db.Query(sql, gCategory).ToList();
    }
    // Search by Name and Category
    else
    {
        sql = @"SELECT b.BGGId, b.Name, b.Description, b.YearPublished, b.GameWeight, b.ImagePath, c.Category
                FROM BoardGame b
                INNER JOIN GameCategory gc ON b.BGGId = gc.BGGId
                INNER JOIN Category c ON gc.Category = c.CategoryID
                WHERE b.Name LIKE CONCAT(@0, '%') AND c.CategoryID = @1
                ORDER BY b.Name ASC";
        data = db.Query(sql, sGName, gCategory).ToList();
    }
}

<!-- Search Form -->
<form method="post" action="/Home/Index" class="search-container text-center mb-2">
    <div class="row align-items">

        <!-- Search by Game Name -->
        <div class="col-md-3 mb-2">
          
            <input type="text" class="form-control" placeholder="Search by name" name="searchGameName" />
        </div>

        <!-- Search by Category -->
        <div class="col-md-3 mb-2">
            
            <select name="searchCategory" class="form-control">
                <option value="">Select Game Category</option>
                @foreach (var game in categories)
                {
                    <option value="@game.CategoryID">@game.Category</option>
                }
            </select>
        </div>

        <!-- Search Button -->
        <div class="col-md-2 mb-2">
            <button type="submit" class="btn btn-primary">Search</button>
        </div>
    </div>
</form>

<!-- Switch Buttons for table and card -->
<div class="col-md-3 mb-2 d-flex justify-content-start gap-2">
    <button class="btn btn-primary" id="showTable">Table</button>
    <button class="btn btn-secondary" id="showCards">Card</button>
</div>

<!-- Heading for the game data-->
<div class="card text-bg-light py-1 mt-2 col-12 mx-auto">
    <h2 class="text-center">Collection of Board Games</h2>
</div>

<!-- Table View -->
<div id="tableView" class="col-12 mx-auto mt-2">
    <table class="table table-bordered">
        @if (data != null && data.Any())
        {
            <thead>
                <tr>
                    <th>BGGId</th>
                    <th>Category</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Year Published</th>
                    <th>Game Weight</th>
                    <th>Image</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var row in data)
                {
                    <tr>
                        <td>@row.BGGId</td>
                        <td>@row.Category</td>
                        <td>@row.Name</td>
                        <td class="overflow-scroll text-wrap" style="width:20rem; height:10rem" title="@row.Description">
                            @(row.Description.Length > 100 ? row.Description.Substring(0, 100) + "..." : row.Description)
                        <td>@row.YearPublished</td>
                        <td>@row.GameWeight</td>
                        <td><img src="@row.ImagePath" alt="@row.Name" style="width:200px; height:auto;" /></td>
                    </tr>
                }
            </tbody>
        }
        else
        {
            <tr><td colspan="7" class="text-center text-danger">Oops! No records were found ...</td></tr>
        }
    </table>
</div>

<!-- Card View -->
<div id="cardView" class="row justify-content-center" style="display:none;">
    @foreach (var row in data)
    {
        <div class="card col-md-3 m-2 shadow-sm">
            <img src="@row.ImagePath" class="card-img-top" alt="@row.Name" style="height:200px; object-fit:cover;">
            <div class="card-body">
                <h5 class="card-title">@row.Name</h5>
                <p class="card-text">@row.Description</p>
                <p><strong>Year:</strong> @row.YearPublished</p>
                <p><strong>Weight:</strong> @row.GameWeight</p>
                <p><strong>Category:</strong> @row.Category</p>
            </div>
        </div>
    }
</div>

<!-- A function to get element by the id of table and the card -->
<script>document.getElementById("showTable").onclick = function () {
        document.getElementById("tableView").style.display = "block";
        document.getElementById("cardView").style.display = "none";
    };
    document.getElementById("showCards").onclick = function () {
        document.getElementById("tableView").style.display = "none";
        document.getElementById("cardView").style.display = "flex";
        document.getElementById("cardView").style.flexWrap = "wrap";
    };</script>

<link href="~/Content/Site.css" rel="stylesheet" />
